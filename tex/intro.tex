% !TEX root = ../thesis.tex

\chapter{绪论}
\section{课题背景和意义}

近年来，直播与分享已经成为人们生活中的一部分，视频流量占全球IP网络总流量的80\%\cite{CiscoVisualNetworking2018}，当海量的媒体数据在网络上传输的时候，会受到网络带宽波动的影响，高带宽占用也会引发网络拥塞等问题。新的视频编码标准可以带来更高的编码效率，节约宝贵的带宽，一直是这些年经久不衰的研究课题。另一方面，当前视频的应用范围已经扩展到视频通话，在线直播，在线教育，云游戏等实时领域，低延迟编码作为实时场景中的关键因素，深刻影响了用户体验，更是视频开发人员面临的一大主要挑战\cite{BitmovinVideoDeveloper2019}。当新的视频编码标准应用在实时系统中，高复杂度的编码工具得到编码效率提升的同时，也带来了更高的编码延时问题。因此，本课题主要是研究新的编码标准在直播系统中的低延时优化。

视频编码技术利用视频在时间和空间维度上的冗余性，对原始的视频序列进行压缩，减小视频文件的码率，以便于存储和传输。视频编码标准主要由国际电信联盟（International Telecommunication Union，ITU）与国际标准化组织（International Organization for Standardization, ISO）/国际电工委员会（International Electrotechnical Commission, IEC）两大组织制定。H.264/AVC制定于21世纪初，虽然运用最广泛，生态最完善，但历史的局限性导致它有着不支持4K、HDR、360以及AR/VR等新需求的缺陷，而H.265/HEVC作为H.264/AVC的下一代标准，虽然在压缩率大大提高，但由于复杂专利池等非技术问题，一直未能建立良好的生态系统。

专利许可对自由和开源软件的负面影响，以及Google在VP9上的成功实践等促生了开放媒体联盟（Alliance for Open Media, AOMedia）的成立与AOMedia Video 1（AV1）的诞生。 AV1是一种开放的，免版税的下一代视频编码格式，旨在用于互联网上的视频传输，取代Google的VP9并与H.265/HEVC竞争。AV1由AOMedia开发，该联盟的成员有半导体行业公司，视频点播提供商，视频内容提供商，软件开发公司和Web浏览器供应商等。AOMedia的成员组成了完整的产业链，共同创建的AV1更是具有开放、免版税的特性，构建了良好的生态系统，相信不久的将来会成为互联网视频传输的主要视频编码格式。

AV1使用了许多高级编码工具\cite{chenOverviewCoreCoding2018}，对比H.265/HEVC与VP9等编码标准达到了更高的编码效率\cite{laudeComparisonJEMAV12018,akyaziComparisonCompressionEfficiency2018}，但这是以相当大的额外的计算复杂度实现的，这可能会限制AV1编码标准在实际应用中的收益。当前AV1的编码器实现尚不完善，编码速度与HEVC和AVC等的标准的成熟实现（如x264，x265）相比较低，未经充分优化，在编码延迟上更是亟须优化的挑战。因此，减少编码器运行时间、降低编码延迟且对标准编码效率的影响有限的算法将非常有益。
% AV1作为较新的编码标准，相关优化研究处于起步阶段，但有以往在编码上的经验可以参考，提出了各种快速算法：基于速率失真模型精度的快速帧内模式决策[[5]](https://ieeexplore.ieee.org/abstract/document/8793367), 基于决策树的AV1快速帧间预测 [[6]](https://ieeexplore.ieee.org/abstract/document/8683580)，多分辨率视频编码中的快速块结构确定[[7]](https://ieeexplore.ieee.org/document/8486492)[[8]](https://ieeexplore.ieee.org/document/8416611)等。

AV1编码器的开源实现有：aom\cite{AV1SourceCode2020}，rav1e\cite{barbatoRustAV1Encoder2019}，SVT-AV1\cite{ScalableVideoTechnology2020}。aom作为AV1的参考编码器，注重算法的验证性，因此在速度的优化上有欠缺。SVT-AV1是Intel和Netflix开源的AV1编码器，目标是为点播（video on demand, VOD）、实时编码、转码等应用场景提供AV1编码。SVT-AV1由于其软件设计，是目前最快的AV1编码器实现。

Intel的可伸缩视频技术（Scalable Video Technology, SVT）\cite{ScalableVideoTechnology2019}编码器体系结构是专为x86处理器设计的，并且特别针对Intel Xeon可扩展处理器进行了大幅优化。SVT架构本身与编码标准无关，它允许将编码器内核拆分为独立运行的线程，每个线程处理视频编码流水线的不同部分。这些线程在不同的处理器内核上并行运行，极大加速了视频编码。SVT-AV1是SVT架构的一个应用实例。目前，SVT-AV1正在活跃开发中，但仍缺少在编码延迟上的优化，无法胜任直播低延迟场景的应用。

本课题将推进SVT-AV1编码器在低延迟场景下的优化，促进AV1编码标准在实时场景下的落地。

\section{直播行业的发展和现状}

直播有着悠久的历史。广义的直播从电台直播开始，一战后，在1920年至1945年间，无线电台通过利用无线电波向广大观众广播而成为第一个电子大众媒介，向大众介绍了即时新闻和娱乐节目。

从1929年9月30日，英国广播公司向英国观众播送了世界上第一台电视的直播，电视直播就开始活跃于大众娱乐。从电视发明的早期到1958年，电视直播得到了广泛的应用，由于录像带在1956年左右发明，并且其初期的成本极高，意味着录像带只是被逐渐采用，而电视直播作为主流。电视直播包括了新闻直播、脱口秀节目、大型娱乐活动如颁奖晚会和选美大赛，以及体育赛事等，一个世纪以来，在大众娱乐方面起到了重要作用。

1995年9月5日，ESPN SportsZone直播了在西雅图水手队和纽约洋基队之间一场棒球比赛，使用位于西雅图的一家名为Progressive Networks的初创公司开发的技术，向全球数以千计的用户提供服务。这是世界上第一场网络直播活动。到2000年代中期，绝大多数Internet流量都是基于HTTP的，并且越来越多地使用内容分发网络（CDN）来确保将流行的内容分发给广大受众。流媒体及其专有协议大都是基于UDP的，越来越难以满足需求。2007年，一家名为Move Networks的公司推出了基于HTTP的自适应流，不再依赖专有的流媒体协议，而是使用HTTP协议以小文件块的形式传输媒体文件，允许使用内容分发网络（CDN）将流媒体广泛分布并进行缓存以提高效率，同时消除了烦人的缓冲和连接问题。随后，微软于2008年推出了Smooth Streaming技术，苹果公司在2009年推出了向iOS设备交付的HTTP实时流媒体（HLS），Adobe于2010年推出HTTP动态流媒体（HDS）。到2012年4月，ISO/IEC MPEG工作组推出了自适应流媒体标准：MPEG-DASH。

% 直播生态，“秀场+直播”没能走通，“社交+直播”举步维艰，最被看好的“游戏+直播”似乎也困难重重。转了一圈，好像只有“电商+直播”实现快速增长
2016年作为“中国视频直播元年”，大量的直播平台兴起，观看直播已经成为了广大网民的娱乐生活中不可缺少的组成部分。2019年可以说是“电商直播元年”，淘宝等电商平台的直播为其带来了高额的流量转化率。

在如今的直播行业形势下有着二八定律：20\%的头部流占据了80\%的流量，而尾部的80\%流只占20\%的流量。对于头部的大主播，往往会有几十万甚至上百万的观众观看，如何降低CDN的流量支出成为重要的挑战，视频编解码技术的发展使之成为可能，从如今主流的H.264编码到H.265再到AV1，每一代编码标准的压缩效率都在极大提升，这意味着传输相同重建质量的视频时，所需的传输带宽大大降低。目前各家直播平台都在向新的编码标准直播解决方案进行探索，twitch宣称将在在2022-2023对头部内容使用AV1视频编码\cite{shenTwitchTalksVP92019}。另一方面，在低延迟方面也有了更高的要求，降低直播延迟可以提升观众和主播的互动质量，提升观众的观看直播体验。

\section{本文主要研究工作}

% 对于直播场景，AV1编码标准有着更高的编码效率的优势，可以有效降低带宽成本，本课题期望探索AV1编码标准在直播场景下的应用。

本课题的目标是实现基于AV1编码标准的低延迟直播系统，从多维度对系统延迟进行优化。经过前期对AV1开源编码器的调研，本文最终选择SVT-AV1作为AV1编码器，FFmpeg作为转码框架，SRT协议作为上行协议，RTSP作为下行协议，搭建了低延迟直播系统原型。

本文的主要研究工作包括对比研究视频传输协议、学习AV1编码标准与编码工具，深入学习研究SVT编码器架构等。学习JND模型，并对JND模型计算实现了向量加速，据此对SVT-AV1编码器进行了快速编码的优化。

本文完成了基于SVT-AV1和FFmpeg的低延迟直播系统原型实现，并在此基础上完成了：
\begin{enumerate} [label=\arabic*)]
    \item 对直播系统的优化，包括：
        \begin{itemize}
            \item FFmpeg中SVT-AV1编码器的预启动优化，消除编码器高启动延迟；
            \item FFmpeg中AV1的RTP封装简单实现，使FFmpeg可以对AV1进行RTP封装，RTSP传输。
        \end{itemize}
    \item 对SVT-AV1编码器的优化，包括：
        \begin{itemize}
            \item 对SVT-AV1多线程框架下，编码过程的延迟profile工具实现，使用该工具分析了SVT架构下的延迟分布；
            \item 系统地测试分析SVT-AV1的编码器参数设定对编码延迟的影响，指导SVT-AV1的低延迟编码配置；
            \item 对RESOURCE的EOS机制的优化；
            \item 测试分析了SVT架构下Tile划分与编码效率和编码延迟的变化关系，为选择合适的Tile划分方案提供指导。
        \end{itemize}
    \item 提出了块级JND模型，并根据该模型实现了超级块划分提前终止算法。
\end{enumerate}

\section{论文结构安排}

本文一共分为6个章节，每一章节的内容安排如下：

第一章为绪论，简要介绍了本课题的研究背景和意义，回顾了直播行业的发展，并阐述了本文的主要研究工作。

第二章为关键技术介绍，简要介绍了视频编码，特别是AV1视频编码标准，对比了常见的流媒体传输协议与封装协议，结合AV1对封装协议的支持性与低延迟、可扩展性的要求，为直播系统原型构建选择合适的流媒体传输协议与封装协议。

第三章为基于AV1的低延迟直播系统原型的构建与系统级的延迟分析与优化，主要包括SVT-AV1的高启动延迟优化与FFmpeg中AV1的RTP封装实现。

第四章为对SVT-AV1编码器的低延迟优化，包括对SVT架构的介绍、对SVT架构的编码延迟profile工具，以及对SVT架构在延迟上的分析优化。

第五章为基于人眼感知的超级块划分快速算法，介绍了人眼视觉特性与JND模型，提出了块级JND模型和对JND模型计算的向量加速。对所提超级块快速划分算法进行了介绍，并对算法实现结果进行了测试与分析。

第六章是对本文总体工作的一些测试。包括对SVT-AV1的多方面优化后的延迟结果与编码效率变化，对构建的直播系统原型的总体延迟测试。